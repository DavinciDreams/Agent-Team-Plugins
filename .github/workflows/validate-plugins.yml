name: Validate Plugins

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate marketplace.json
        run: |
          echo "Validating marketplace.json..."
          python3 -c "
          import json, sys
          with open('.claude-plugin/marketplace.json') as f:
              data = json.load(f)
          assert 'name' in data, 'Missing name'
          assert 'plugins' in data, 'Missing plugins'
          for p in data['plugins']:
              assert 'name' in p, f'Plugin missing name'
              assert 'source' in p, f'Plugin {p[\"name\"]} missing source'
              print(f'  Plugin: {p[\"name\"]} -> {p[\"source\"]}')
          print(f'Validated {len(data[\"plugins\"])} plugins')
          "

      - name: Validate team plugin.json files
        run: |
          echo "Validating team plugin.json files..."
          for f in teams/*/. claude-plugin/plugin.json; do
            if [ -f "$f" ]; then
              echo "  Checking $f"
              python3 -c "
          import json, sys
          with open('$f') as fp:
              data = json.load(fp)
          assert 'name' in data, 'Missing name in $f'
          assert 'description' in data, 'Missing description in $f'
          print(f'    OK: {data[\"name\"]}')
          "
            fi
          done

      - name: Validate team.json files
        run: |
          echo "Validating team.json files..."
          for f in teams/*/team.json; do
            if [ -f "$f" ] && [[ "$f" != *"_template"* ]]; then
              echo "  Checking $f"
              python3 -c "
          import json, sys
          with open('$f') as fp:
              data = json.load(fp)
          assert 'team' in data, 'Missing team in $f'
          assert 'members' in data, 'Missing members in $f'
          assert 'workflows' in data, 'Missing workflows in $f'
          print(f'    OK: {data[\"team\"]} ({len(data[\"members\"])} members)')
          "
            fi
          done

      - name: Validate hooks.json files
        run: |
          echo "Validating hooks.json files..."
          for f in teams/*/hooks/hooks.json; do
            if [ -f "$f" ] && [[ "$f" != *"_template"* ]]; then
              echo "  Checking $f"
              python3 -c "
          import json
          with open('$f') as fp:
              data = json.load(fp)
          assert 'hooks' in data, 'Missing hooks in $f'
          print(f'    OK: {len(data[\"hooks\"])} hook types')
          "
            fi
          done

      - name: Check agent frontmatter
        run: |
          echo "Checking agent frontmatter..."
          for f in teams/*/agents/*.md; do
            if [ -f "$f" ] && [[ "$(basename $f)" != _* ]]; then
              echo "  Checking $f"
              head -1 "$f" | grep -q "^---" || { echo "    ERROR: Missing frontmatter in $f"; exit 1; }
              grep -q "^name:" "$f" || { echo "    ERROR: Missing name in $f"; exit 1; }
              grep -q "^description:" "$f" || { echo "    ERROR: Missing description in $f"; exit 1; }
              echo "    OK"
            fi
          done

      - name: Verify source paths
        run: |
          echo "Verifying plugin source paths exist..."
          python3 -c "
          import json, os
          with open('.claude-plugin/marketplace.json') as f:
              data = json.load(f)
          for p in data['plugins']:
              src = p['source']
              if isinstance(src, str) and src.startswith('./'):
                  assert os.path.isdir(src), f'Source path not found: {src} for plugin {p[\"name\"]}'
                  assert os.path.isfile(os.path.join(src, '.claude-plugin', 'plugin.json')), f'Missing plugin.json in {src}'
                  print(f'  {p[\"name\"]}: {src} OK')
          "
